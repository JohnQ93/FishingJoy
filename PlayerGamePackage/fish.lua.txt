-- 1.1.1点击宝箱领取的金币钻石太拥挤，分散一点

local UnityEngine = CS.UnityEngine
xlua.hotfix(CS.Treasour,"CreatePrize",function(self)
	for i=0,4,1 do
		local go = UnityEngine.GameObject.Instantiate(self.gold,self.transform.position+UnityEngine.Vector3(-10+i*40,0,0),self.transform.rotation)
		go.transform:SetParent(self.cavas)
		local go1 = UnityEngine.GameObject.Instantiate(self.diamond,self.transform.position+UnityEngine.Vector3(0,40,0)+UnityEngine.Vector3(-10+i*40,0,0),self.transform.rotation)
		go1.transform:SetParent(self.cavas)
	end
end)

-- 1.1.2玩家金币钻石不够时没有相应处理
xlua.private_accessible(CS.Gun)
xlua.hotfix(CS.Gun,"Attack",function(self)

	-- 1.2.1与UI交互时不能发射子弹
	if UnityEngine.EventSystems.EventSystem.current:IsPointerOverGameObject() then
		return
	end

	-- 1.3.2 炮台3太强，且钻石没用处，不削弱，只有氪金才可使用
	if self.gold < 1 + (self.gunLevel - 1) * 2 then
		return
	end
	if self.gunLevel == 3 and self.diamond < 3 then
		return
	end

	if UnityEngine.Input.GetMouseButtonDown(0) then
		self.bulletAudio.clip = self.bulletAudios[self.gunLevel - 1]
		self.bulletAudio:Play()

		if self.Butterfly then
			UnityEngine.GameObject.Instantiate(self.Bullets[self.gunLevel - 1], self.attackPos.position, self.attackPos.rotation * UnityEngine.Quaternion.Euler(0,0,20))
			UnityEngine.GameObject.Instantiate(self.Bullets[self.gunLevel - 1], self.attackPos.position, self.attackPos.rotation * UnityEngine.Quaternion.Euler(0,0,-20))
		end

		UnityEngine.GameObject.Instantiate(self.Bullets[self.gunLevel - 1], self.attackPos.position, self.attackPos.rotation)

		-- 3级炮台同时会扣减钻石
		if not self.canShootForFree then
			if self.gunLevel == 3 then
				self:DiamandsChange(-3)
			end
			self:GoldChange(-1 - (self.gunLevel - 1) * 2)
		end

		self.attackCD = 0
		self.attack = false
	end
end)

-- 1.2.2技能扣钻石太多
xlua.private_accessible(CS.Fire)
xlua.hotfix(CS.Fire,"Start",function(self)
	self.reduceDiamands = 8
end)

xlua.private_accessible(CS.ButterFly)
xlua.hotfix(CS.ButterFly,"Start",function(self)
	self.reduceDiamands = 5
end)

xlua.private_accessible(CS.Ice)
xlua.hotfix(CS.Ice,"Start",function(self)
	self.reduceDiamands = 8
end)

-- 1.2.3boss撞击玩家数值变动一样且不是减少是增加
local util = require 'util'
util.hotfix_ex(CS.Boss,"Start",function(self)
	self:Start()
	self.m_reduceGold = self.m_reduceGold - 20
end)

util.hotfix_ex(CS.DeffendBoss,"Start",function(self)
	self:Start()
	self.m_reduceGold = self.m_reduceGold - 30
end)

util.hotfix_ex(CS.InvisibleBoss,"Start",function(self)
	self:Start()
	self.m_reduceDiamond = self.m_reduceDiamond - 10
end)

-- 1.3.1 boss撞击玩家当钻石金币不够时会产生负数
--[[
util.hotfix_ex(CS.Gun, "GoldChange", function(self, number)
	self:GoldChange(number)
	if self.gold<-number then
		self.gold=0
	end
end)
--]]

util.hotfix_ex(CS.Gun, "DiamandsChange", function(self, number)
	self:DiamandsChange(number)
	if self.diamond<-number then
		self.diamond=0
	end
end)

-- 1.3.3 大鱼太多
xlua.hotfix(CS.CreateFish, "Start", function(self)

	CS.HotFixScript.LoadResource("level3fish3", "gameobject/enemy.ab")
	newFish = CS.HotFixScript.GetResource("level3fish3")

end)

xlua.private_accessible(CS.CreateFish)
xlua.hotfix(CS.CreateFish, "Update", function(self)

	--鱼群的生成
	self:CreateALotOfFish()

    --单种鱼的生成
    if self.ItemtimeVal >= 0.5 then
        --位置随机数
        self.num = UnityEngine.Mathf.Floor(UnityEngine.Random.Range(0, 4))
        --游戏物体随机数
        self.ItemNum = UnityEngine.Mathf.Floor(UnityEngine.Random.Range(1, 101))

		local halfLength = UnityEngine.Mathf.Floor(self.fishList.Length/2)

		local littlefishTypeIndex = UnityEngine.Mathf.Floor(UnityEngine.Random.Range(0, halfLength))
		local bigfishTypeIndex = UnityEngine.Mathf.Floor(UnityEngine.Random.Range(halfLength, self.fishList.Length))
		local itemTypeIndex = UnityEngine.Mathf.Floor(UnityEngine.Random.Range(0, self.item.Length))

        --产生气泡
        if self.ItemNum < 20 then
            self:CreateGameObject(self.item[3]);
        end

        if self.ItemNum <= 42 then
			for i=0,2,1 do
				self:CreateGameObject(self.fishList[littlefishTypeIndex])
			end
			self:CreateGameObject(self.item[itemTypeIndex])

        elseif self.ItemNum >= 43 and self.ItemNum < 72 then
            for i=0,1,1 do
				self:CreateGameObject(self.fishList[bigfishTypeIndex])
			end
			self:CreateGameObject(self.item[itemTypeIndex])

		elseif self.ItemNum >= 73 and self.ItemNum < 83 then
            self:CreateGameObject(newFish)

        elseif self.ItemNum >= 84 and self.ItemNum < 86 then
            self:CreateGameObject(self.boss)

        elseif self.ItemNum >= 87 and self.ItemNum <= 88 then
            self:CreateGameObject(self.boss2)

        elseif self.ItemNum == 100 then
            self:CreateGameObject(self.boss3)

        else
            self:CreateGameObject(self.item[0]);
        end

		self.ItemtimeVal = 0;
    else
        self.ItemtimeVal = self.ItemtimeVal + UnityEngine.Time.deltaTime;
    end

end)

-- **************************************************************************************
-- 1.4.1 用传统的概率来扑鱼
xlua.private_accessible(CS.Fish)
xlua.hotfix(CS.Fish, "TakeDamage", function(self,attackValue)

	if CS.Gun.Instance.Fire then
        attackValue = attackValue*2;
    end
    local catchValue = UnityEngine.Mathf.Floor(UnityEngine.Random.Range(0,100))
    if catchValue <= (50-(self.hp-attackValue))/2 then
        self.isDead = true;
        for i=0,8,1 do
            UnityEngine.GameObject.Instantiate(self.pao, self.transform.position, UnityEngine.Quaternion.Euler(self.transform.eulerAngles + UnityEngine.Vector3(0, 45 * i, 0)));
        end

        self.gameObjectAni:SetTrigger("Die");
        self:Invoke("Prize", 0.7);
    end

end)

xlua.private_accessible(CS.Boss)
xlua.hotfix(CS.Boss, "TakeDamage", function(self,attackValue)

	if CS.Gun.Instance.Fire then
        attackValue = attackValue*2;
	end

    local catchValue = UnityEngine.Mathf.Floor(UnityEngine.Random.Range(0,100))
    if catchValue <= (attackValue*3 - self.hp/10 + 5) then
       UnityEngine.GameObject.Instantiate(self.deadEeffect, self.transform.position, self.transform.rotation)
       CS.Gun.Instance:GoldChange(self.GetGold * 10)
       CS.Gun.Instance:DiamandsChange(self.GetDiamands * 10);

       for i = 0,10,1 do
            local itemGold = UnityEngine.GameObject.Instantiate(self.gold, self.transform.position, UnityEngine.Quaternion.Euler(self.transform.eulerAngles + UnityEngine.Vector3(0, 18 + 36 * (i - 1), 0)))
            itemGold:GetComponent("Gold").bossPrize = true

			local itemDiamond = UnityEngine.GameObject.Instantiate(self.diamands, self.transform.position, UnityEngine.Quaternion.Euler(self.transform.eulerAngles + UnityEngine.Vector3(0, 36 + 36 * (i - 1), 0)))
            itemDiamond:GetComponent("Gold").bossPrize = true
       end
       UnityEngine.Object.Destroy(self.gameObject);
    end

end)

-- **************************************************************************************
-- 1.4.2 改为玩家按下ad键来旋转炮台
xlua.hotfix(CS.Gun, "RotateGun", function(self)

	if UnityEngine.Input.GetKey(UnityEngine.KeyCode.A) then
		self.transform:Rotate(UnityEngine.Vector3.forward * self.rotateSpeed)
	end
	if UnityEngine.Input.GetKey(UnityEngine.KeyCode.D) then
		self.transform:Rotate(-UnityEngine.Vector3.forward * self.rotateSpeed)
	end

	self:ClampAngle()
end)

xlua.private_accessible(CS.GunImage)
xlua.hotfix(CS.GunImage, "RotateGun", function(self)

	if UnityEngine.Input.GetKey(UnityEngine.KeyCode.A) then
		self.transform:Rotate(UnityEngine.Vector3.forward * self.rotateSpeed)
	end
	if UnityEngine.Input.GetKey(UnityEngine.KeyCode.D) then
		self.transform:Rotate(-UnityEngine.Vector3.forward * self.rotateSpeed)
	end

	self:ClampAngle()
end)

-- **************************************************************************************
-- 2.0 增加海浪
xlua.private_accessible(CS.HotFixEmpty)
xlua.hotfix(CS.HotFixEmpty, "Start", function(self)

end)

xlua.hotfix(CS.HotFixEmpty, "Update", function(self)

end)

xlua.hotfix(CS.HotFixEmpty, "OnTriggerEnter", function(self,other)

end)

xlua.hotfix(CS.HotFixEmpty, "BehaviourMethod", function(self)

end)